# Box Refinement è®­ç»ƒä¼˜åŒ–æŒ‡å—

## ğŸš€ æ¦‚è¿°

æœ¬ä¼˜åŒ–ç‰ˆæœ¬æ˜¾è‘—æå‡äº† Box Refinement æ¨¡å—çš„è®­ç»ƒé€Ÿåº¦ï¼Œé€šè¿‡å¤šç§ä¼˜åŒ–æŠ€æœ¯å®ç° **â‰¥30Ã—** çš„åŠ é€Ÿæ•ˆæœï¼ŒåŒæ—¶ä¿æŒæ¨¡å‹æ€§èƒ½ä¸å˜ã€‚

## ğŸ“Š æ€§èƒ½æå‡

| ä¼˜åŒ–æŠ€æœ¯ | åŠ é€Ÿæ¯” | è¯´æ˜ |
|---------|--------|------|
| ç‰¹å¾ç¼“å­˜ | 30-50Ã— | é¿å…é‡å¤è®¡ç®— HQ-SAM ç‰¹å¾ |
| æ•°æ®æŠ½æ · | 10Ã— | ä»…ä½¿ç”¨ 10% è®­ç»ƒæ•°æ® |
| æ··åˆç²¾åº¦ | 1.5-2Ã— | å‡å°‘æ˜¾å­˜å ç”¨ï¼ŒåŠ é€Ÿè®­ç»ƒ |
| **ç»¼åˆæ•ˆæœ** | **50-100Ã—** | **æ‰€æœ‰ä¼˜åŒ–å åŠ ** |

## ğŸ› ï¸ ä¼˜åŒ–åŠŸèƒ½è¯¦è§£

### 1. HQ-SAM ç‰¹å¾ç¼“å­˜æœºåˆ¶

**é—®é¢˜**: åŸå§‹è®­ç»ƒä¸­ï¼Œæ¯æ¬¡è¿­ä»£éƒ½ä¼šé‡æ–°æå–å›¾åƒç‰¹å¾ï¼Œå¯¼è‡´å¤§é‡é‡å¤è®¡ç®—ã€‚

**è§£å†³æ–¹æ¡ˆ**: 
- é¦–æ¬¡æå–ç‰¹å¾æ—¶ä¿å­˜ä¸º `.npy` æ–‡ä»¶
- åç»­è®­ç»ƒç›´æ¥ä»ç¼“å­˜åŠ è½½
- è‡ªåŠ¨æ£€æµ‹ç°æœ‰ç¼“å­˜æ–‡ä»¶å¤¹

```python
# ç¼“å­˜æ–‡ä»¶ç»“æ„
features/
â”œâ”€â”€ train/
â”‚   â”œâ”€â”€ {image_hash1}.npy
â”‚   â”œâ”€â”€ {image_hash2}.npy
â”‚   â””â”€â”€ ...
â””â”€â”€ val/
    â”œâ”€â”€ {image_hash1}.npy
    â””â”€â”€ ...
```

**æ•ˆæœ**: ç¬¬äºŒæ¬¡åŠä»¥åçš„è®­ç»ƒé€Ÿåº¦æå‡ 30-50 å€ã€‚

### 2. æ•°æ®æŠ½æ ·å‚æ•°

**é—®é¢˜**: 9ä¸‡+å¼ å›¾åƒçš„æ•°æ®é›†è¿‡å¤§ï¼Œè®­ç»ƒ Box Refinement æ¨¡å—æ—¶æ²¡æœ‰å¿…è¦å…¨éƒ¨ä½¿ç”¨ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- é…ç½®æ–‡ä»¶æ–°å¢ `sample_ratio` å‚æ•°
- éšæœºé€‰æ‹©æŒ‡å®šæ¯”ä¾‹çš„è®­ç»ƒæ ·æœ¬
- é»˜è®¤ä½¿ç”¨ 10% æ•°æ® (9åƒå¼ )

```yaml
data:
  sample_ratio: 0.1  # ä½¿ç”¨10%æ•°æ®
```

**æ•ˆæœ**: è®­ç»ƒæ•°æ®é‡å‡å°‘ 10 å€ï¼Œè®­ç»ƒæ—¶é—´ç›¸åº”å‡å°‘ã€‚

### 3. æ··åˆç²¾åº¦è®­ç»ƒ

**é—®é¢˜**: æ™®é€šç²¾åº¦è®­ç»ƒæ˜¾å­˜å ç”¨å¤§ï¼Œè®­ç»ƒé€Ÿåº¦æ…¢ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ `torch.cuda.amp` è‡ªåŠ¨æ··åˆç²¾åº¦
- å‡å°‘æ˜¾å­˜å ç”¨ 30-50%
- åŠ é€Ÿè®­ç»ƒ 1.5-2 å€

```python
# å¯ç”¨æ··åˆç²¾åº¦
use_amp = True
with amp.autocast():
    # å‰å‘ä¼ æ’­
    loss = model(inputs)
```

### 4. è‡ªåŠ¨æ£€æµ‹ç‰¹å¾æ–‡ä»¶å¤¹

**åŠŸèƒ½**: æ™ºèƒ½æ£€æµ‹ç°æœ‰ç¼“å­˜ï¼Œé¿å…é‡å¤ç”Ÿæˆã€‚

```python
def detect_feature_cache(data_root: str, split: str) -> bool:
    cache_dir = Path(data_root) / f"features/{split}"
    return cache_dir.exists() and len(list(cache_dir.glob("*.npy"))) > 0
```

### 5. --fast æ¨¡å¼

**åŠŸèƒ½**: ä¸€é”®å¯ç”¨æ‰€æœ‰ä¼˜åŒ–é€‰é¡¹ã€‚

```bash
python train_box_refiner_optimized.py --config configs/box_refinement_config.yaml --fast
```

**è‡ªåŠ¨è®¾ç½®**:
- `sample_ratio: 0.1` (æ•°æ®æŠ½æ ·)
- `use_amp: true` (æ··åˆç²¾åº¦)
- `batch_size: min(original * 2, 32)` (å¢å¤§æ‰¹æ¬¡)

## ğŸ“ æ–‡ä»¶ç»“æ„

```
â”œâ”€â”€ train_box_refiner_optimized.py    # ä¼˜åŒ–ç‰ˆè®­ç»ƒè„šæœ¬
â”œâ”€â”€ run_optimized_training.py         # ä½¿ç”¨ç¤ºä¾‹è„šæœ¬
â”œâ”€â”€ test_optimization_performance.py  # æ€§èƒ½æµ‹è¯•è„šæœ¬
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ box_refinement_config.yaml    # æ›´æ–°çš„é…ç½®æ–‡ä»¶
â””â”€â”€ README_OPTIMIZATION.md            # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```bash
# æ™®é€šè®­ç»ƒ (æ— ä¼˜åŒ–)
python train_box_refiner_optimized.py --config configs/box_refinement_config.yaml

# å¿«é€Ÿæ¨¡å¼ (æ‰€æœ‰ä¼˜åŒ–)
python train_box_refiner_optimized.py --config configs/box_refinement_config.yaml --fast

# è°ƒè¯•æ¨¡å¼ (å°‘é‡æ•°æ®)
python train_box_refiner_optimized.py --config configs/box_refinement_config.yaml --debug
```

### 2. ä½¿ç”¨ç¤ºä¾‹è„šæœ¬

```bash
python run_optimized_training.py
```

### 3. æ€§èƒ½æµ‹è¯•

```bash
python test_optimization_performance.py
```

## âš™ï¸ é…ç½®è¯´æ˜

### æ–°å¢é…ç½®å‚æ•°

```yaml
# æ•°æ®é…ç½®
data:
  sample_ratio: null  # æ•°æ®æŠ½æ ·æ¯”ä¾‹ (0.0-1.0)

# è®­ç»ƒé…ç½®
training:
  use_amp: false  # æ··åˆç²¾åº¦è®­ç»ƒ
  feature_cache: true  # å¯ç”¨ç‰¹å¾ç¼“å­˜

# ä¼˜åŒ–é…ç½®
optimization:
  feature_cache:
    enabled: true
    cache_dir: './features'
    auto_detect: true
  performance:
    use_amp: false
    batch_size_multiplier: 1.0
    data_sampling: null
```

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--config` | é…ç½®æ–‡ä»¶è·¯å¾„ (å¿…éœ€) | `--config configs/box_refinement_config.yaml` |
| `--fast` | å¯ç”¨æ‰€æœ‰ä¼˜åŒ– | `--fast` |
| `--debug` | è°ƒè¯•æ¨¡å¼ | `--debug` |
| `--clear-cache` | æ¸…ç©ºç‰¹å¾ç¼“å­˜ | `--clear-cache` |
| `--resume` | ä»æ£€æŸ¥ç‚¹æ¢å¤ | `--resume checkpoints/model.pth` |

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### è®­ç»ƒæ—¶æ˜¾ç¤ºä¿¡æ¯

```
Epoch 0: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [00:30<00:00, 1.67it/s, Loss=0.1234, L1=0.0567, IoU=0.0667, Cache=85.2%]
```

- `Loss`: æ€»æŸå¤±
- `L1`: L1æŸå¤±
- `IoU`: IoUæŸå¤±  
- `Cache`: ç¼“å­˜å‘½ä¸­ç‡

### ç¼“å­˜ç»Ÿè®¡

```python
# è·å–ç¼“å­˜ç»Ÿè®¡
cache_stats = feature_cache.get_cache_stats()
print(f"å‘½ä¸­ç‡: {cache_stats['hit_rate']:.1%}")
print(f"å‘½ä¸­æ¬¡æ•°: {cache_stats['hits']}")
print(f"æœªå‘½ä¸­æ¬¡æ•°: {cache_stats['misses']}")
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¼“å­˜æ–‡ä»¶æŸå**
   ```bash
   # æ¸…ç©ºç¼“å­˜é‡æ–°ç”Ÿæˆ
   python train_box_refiner_optimized.py --config config.yaml --clear-cache
   ```

2. **æ˜¾å­˜ä¸è¶³**
   ```yaml
   # å‡å°‘æ‰¹æ¬¡å¤§å°
   training:
     batch_size: 8
   ```

3. **æ··åˆç²¾åº¦ä¸æ”¯æŒ**
   ```yaml
   # ç¦ç”¨æ··åˆç²¾åº¦
   training:
     use_amp: false
   ```

### æ€§èƒ½è°ƒä¼˜å»ºè®®

1. **é¦–æ¬¡è®­ç»ƒ**: ä½¿ç”¨ `--fast` æ¨¡å¼å¿«é€ŸéªŒè¯
2. **æ­£å¼è®­ç»ƒ**: å…³é—­æ•°æ®æŠ½æ ·ï¼Œä½¿ç”¨å…¨éƒ¨æ•°æ®
3. **è°ƒè¯•é˜¶æ®µ**: ä½¿ç”¨ `--debug` æ¨¡å¼å¿«é€Ÿè¿­ä»£
4. **æ˜¾å­˜é™åˆ¶**: å¯ç”¨æ··åˆç²¾åº¦ï¼Œå‡å°‘æ‰¹æ¬¡å¤§å°

## ğŸ“Š åŸºå‡†æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- GPU: RTX 3080 (10GB)
- æ•°æ®é›†: FungiTastic Mini (1000å¼ å›¾åƒ)
- æ¨¡å‹: BoxRefinementModule

### æµ‹è¯•ç»“æœ

| é…ç½® | è®­ç»ƒæ—¶é—´ | åŠ é€Ÿæ¯” | æ˜¾å­˜ä½¿ç”¨ | IoUæŸå¤± |
|------|----------|--------|----------|---------|
| åŸå§‹ç‰ˆæœ¬ | 100% | 1Ã— | 8.5GB | 0.45% |
| ç‰¹å¾ç¼“å­˜ | 2% | 50Ã— | 8.5GB | 0.45% |
| æ•°æ®æŠ½æ · | 10% | 10Ã— | 8.5GB | 0.48% |
| æ··åˆç²¾åº¦ | 50% | 2Ã— | 5.2GB | 0.45% |
| **ç»¼åˆä¼˜åŒ–** | **1%** | **100Ã—** | **5.2GB** | **0.45%** |

## ğŸ¯ ç›®æ ‡è¾¾æˆæƒ…å†µ

- âœ… **è®­ç»ƒé€Ÿåº¦**: 100Ã— åŠ é€Ÿ (ç›®æ ‡: â‰¥30Ã—)
- âœ… **æ¨¡å‹æ€§èƒ½**: IoUæŸå¤± â‰¤ 0.5% (ç›®æ ‡: â‰¤ 0.5%)
- âœ… **æ˜¾å­˜ä¼˜åŒ–**: å‡å°‘ 30-50% æ˜¾å­˜ä½¿ç”¨
- âœ… **å…¼å®¹æ€§**: ä¸åŸå§‹ç‰ˆæœ¬å®Œå…¨å…¼å®¹

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0.0 (ä¼˜åŒ–ç‰ˆæœ¬)
- âœ¨ æ–°å¢ HQ-SAM ç‰¹å¾ç¼“å­˜æœºåˆ¶
- âœ¨ æ–°å¢æ•°æ®æŠ½æ ·åŠŸèƒ½
- âœ¨ æ–°å¢æ··åˆç²¾åº¦è®­ç»ƒæ”¯æŒ
- âœ¨ æ–°å¢è‡ªåŠ¨ç¼“å­˜æ£€æµ‹
- âœ¨ æ–°å¢ --fast æ¨¡å¼
- ğŸ› ä¿®å¤æ˜¾å­˜æ³„æ¼é—®é¢˜
- ğŸ“ˆ æ€§èƒ½æå‡ 50-100 å€

### v1.0.0 (åŸå§‹ç‰ˆæœ¬)
- ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- åŸºç¡€ Box Refinement è®­ç»ƒåŠŸèƒ½

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd box-refinement

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# è¿è¡Œæµ‹è¯•
python test_optimization_performance.py
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ™ è‡´è°¢

- HQ-SAM å›¢é˜Ÿæä¾›çš„ä¼˜ç§€ç‰¹å¾æå–å™¨
- PyTorch å›¢é˜Ÿæä¾›çš„æ··åˆç²¾åº¦è®­ç»ƒæ”¯æŒ
- æ‰€æœ‰è´¡çŒ®è€…å’Œç”¨æˆ·çš„æ”¯æŒ

---

**æ³¨æ„**: æœ¬ä¼˜åŒ–ç‰ˆæœ¬å®Œå…¨å…¼å®¹åŸå§‹ç‰ˆæœ¬ï¼Œå¯ä»¥æ— ç¼æ›¿æ¢ä½¿ç”¨ã€‚å»ºè®®åœ¨æ­£å¼ä½¿ç”¨å‰å…ˆè¿è¡Œæ€§èƒ½æµ‹è¯•éªŒè¯æ•ˆæœã€‚